{% extends "layout.html" %}
{% load static %}

{% block content %}
<main class="templates-page">
    <div class="page-header">
        <h2>Recherche de plasmides</h2>
    </div>

    <!-- Onglets pleine largeur -->
    <div class="tabs flex w-full mb-6 bg-gray-100 rounded-lg overflow-hidden shadow-sm">
        <a href="?privacy=private" 
           class="tab flex-1 text-center py-3 font-semibold {% if request.GET.privacy == 'private' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
           Mes plasmides
        </a>
        <a href="?privacy=public" 
           class="tab flex-1 text-center py-3 font-semibold {% if request.GET.privacy == 'public' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
           Banque de plasmides d'InSillyClo
        </a>
        <a href="?privacy=search_enter" 
           class="tab flex-1 text-center py-3 font-semibold {% if request.GET.privacy == 'search_enter' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
           Recherche Entrez
        </a>
    </div>

    {% if request.GET.privacy == "private" %}
        {% if user.is_authenticated %}
            {% if campaigns_with_plasmids %}
                <div class="inline-form">
                    <h3>Plasmides de {{ user.first_name }}</h3>
                    <form method="get" class="inline-form">
                        <input type="hidden" name="privacy" value="private">
                        <input type="text" name="q" placeholder="Entrez un nom ..." value="{{ request.GET.q|default:'' }}">
                        <button type="submit" class="btn">Rechercher</button>
                    </form>
                </div>

                {% for item in campaigns_with_plasmids %}
                    <div class="collapse-container">
                        <div class="collapse-header">
                            <h3>{{ item.campaign.name }}</h3>
                            <span class="status-badge {{ item.campaign.status }}">{{ item.campaign.status|capfirst }}</span>
                        </div>
                        <div class="collapse-body">
                            <p>Créée le : {{ item.campaign.created_at|date:"d/m/Y H:i" }} | Template : {{ item.campaign.template_file.name|default:"-" }}</p>

                            <!-- Plasmides de l'archive -->
                            <h4>Plasmides de l'archive :</h4>
                            {% if item.plasmids_archive %}
                                <div class="templates-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Nom</th>
                                                <th>Organisme</th>
                                                <th>Longueur (bp)</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for p in item.plasmids_archive %}
                                            <tr>
                                                <td>{{ p.name }}</td>
                                                <td>{{ p.organism|default:"-" }}</td>
                                                <td>{{ p.length|default:"-" }}</td>
                                                <td>
                                                    <a href="{% url 'templates:user_view_plasmid_archive' item.campaign.id %}?plasmid={{ p.name|urlencode }}" class="btn btn-sm btn-secondary">
                                                        Visualiser
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="empty-row">Aucun plasmide dans l'archive.</p>
                            {% endif %}

                            <!-- Plasmides des résultats -->
                            <h4>Plasmides des résultats :</h4>
                            {% if item.plasmids_results %}
                                <div class="templates-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Nom</th>
                                                <th>Organisme</th>
                                                <th>Longueur (bp)</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for p in item.plasmids_results %}
                                            <tr>
                                                <td>{{ p.name }}</td>
                                                <td>{{ p.organism|default:"-" }}</td>
                                                <td>{{ p.length|default:"-" }}</td>
                                                <td>
                                                    <a href="{% url 'templates:user_view_plasmid' item.campaign.id %}?plasmid={{ p.name|urlencode }}" class="btn btn-sm btn-secondary">
                                                        Visualiser
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="empty-row">Aucun plasmide dans le résultat.</p>
                            {% endif %}
                        </div>
                    </div>
                    <hr>
                {% endfor %}
            {% else %}
                <p>Aucune campagne trouvée.</p>
            {% endif %}
        {% else %}
            <p>Veuillez vous connecter pour voir vos plasmides privés.</p>
            <a href="{% url 'users:login' %}" class="btn btn-primary">Connexion</a>
        {% endif %}

    {% elif request.GET.privacy == "public" %}
        <h3>Plasmides publics d'InSillyClo</h3>
        <p>Code à implémenter.</p>

    {% elif request.GET.privacy == "search_enter" %}
        <h3>Recherche avancée</h3>
        <form method="get" class="inline-form">
            <input type="hidden" name="privacy" value="search_enter">
            <input type="text" name="q" placeholder="Entrez un terme..." value="{{ request.GET.q|default:'' }}">
            <button type="submit" class="btn">Rechercher</button>
        </form>
        {% if request.GET.q %}
            <p>Résultats pour : <strong>{{ request.GET.q }}</strong></p>
        {% else %}
            <p>Aucun terme saisi.</p>
        {% endif %}

    {% else %}
        <p>Sélectionnez un onglet pour commencer.</p>
    {% endif %}

</main>
{% endblock %}
