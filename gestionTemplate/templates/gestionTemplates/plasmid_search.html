{% extends "layout.html" %}
{% load static %}

{% block content %}
<main class="templates-page">
    <div class="page-header">
        <h2>Recherche de plasmides</h2>
    </div>

    <!-- Onglets principaux -->
    <div class="tabs flex w-full mb-6 bg-gray-100 rounded-lg overflow-hidden shadow-sm">
        <a href="?privacy=private"
           class="tab flex-1 text-center py-3 font-semibold {% if request.GET.privacy == 'private' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
           Recherche privée
        </a>
        <a href="?privacy=search_enter"
           class="tab flex-1 text-center py-3 font-semibold {% if request.GET.privacy == 'search_enter' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
           Recherche NCBI
        </a>
    </div>

    {% if request.GET.privacy == "private" %}
        {% if user.is_authenticated %}

            <!-- Sous-onglets -->
            <div class="tabs flex w-full mb-4 bg-gray-100 rounded-lg overflow-hidden shadow-sm">
                <a href="?privacy=private&filter=public"
                   class="tab flex-1 text-center py-2 font-semibold {% if filter_type == 'public' or not filter_type %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
                    Banque publique
                </a>
                <a href="?privacy=private&filter=mine"
                   class="tab flex-1 text-center py-2 font-semibold {% if filter_type == 'mine' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
                    Mes simulations
                </a>
                <a href="?privacy=private&filter=my_collections"
                   class="tab flex-1 text-center py-2 font-semibold {% if filter_type == 'my_collections' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
                    Mes collections
                </a>
                <a href="?privacy=private&filter=team_collections"
                   class="tab flex-1 text-center py-2 font-semibold {% if filter_type == 'team_collections' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
                    Collections de mes équipes
                </a>
            </div>

            <!-- Banque publique -->
            {% if filter_type == 'public' or not filter_type %}
                <div class="collapse-container mb-4">
                    <div class="collapse-header p-2 bg-gray-200 rounded flex justify-between items-center">
                        <h3>Banque publique de plasmides</h3>
                    </div>
                    <div class="collapse-body p-3 border border-t-0 rounded-b">
                        <form method="get" class="inline-form flex gap-2 flex-wrap mb-3">
                            <input type="hidden" name="privacy" value="private">
                            <input type="hidden" name="filter" value="public">
                            <input type="text" name="name" placeholder="Nom du plasmide" value="{{ request.GET.name|default:'' }}" class="flex-1 px-2 py-1 border rounded">
                            <input type="text" name="organism" placeholder="Organisme" value="{{ request.GET.organism|default:'' }}" class="flex-1 px-2 py-1 border rounded">
                            <input type="text" name="sequence" placeholder="Motif de séquence" value="{{ request.GET.sequence|default:'' }}" class="flex-1 px-2 py-1 border rounded">
                            <input type="text" name="site" placeholder="Site / gène / promoteur" value="{{ request.GET.site|default:'' }}" class="flex-1 px-2 py-1 border rounded">
                            <button type="submit" class="btn btn-primary px-4 py-1">Rechercher</button>
                        </form>

                        {% if public_plasmids %}
                            <div class="templates-table overflow-x-auto mt-3">
                                <table class="table-auto w-full border">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border px-2 py-1">Nom</th>
                                            <th class="border px-2 py-1">Organisme</th>
                                            <th class="border px-2 py-1">Longueur (bp)</th>
                                            <th class="border px-2 py-1">Sites / gènes</th>
                                            <th class="border px-2 py-1">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in public_plasmids %}
                                        <tr>
                                            <td class="border px-2 py-1">{{ p.name }}</td>
                                            <td class="border px-2 py-1">{{ p.organism|default:"-" }}</td>
                                            <td class="border px-2 py-1">{{ p.length|default:"-" }}</td>
                                            <td class="border px-2 py-1">{{ p.display_features|default:"-" }}</td>
                                            <td class="border px-2 py-1 flex gap-1 flex-wrap">
                                                <a href="{% url 'templates:download_plasmid' %}?plasmid_id={{ p.id }}" class="btn btn-sm btn-primary">Télécharger {{ p.name }}.gb</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="empty-row mt-4">Aucun plasmide trouvé.</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Mes simulations -->
            {% if filter_type == 'mine' %}
                {% if campaigns_with_plasmids %}
                    {% for item in campaigns_with_plasmids %}
                        <div class="collapse-container mb-4">
                            <div class="collapse-header flex justify-between items-center p-2 bg-gray-200 rounded">
                                <h3>{{ item.campaign.name }}</h3>
                                <span class="status-badge {{ item.campaign.status }}">{{ item.campaign.status|capfirst }}</span>
                            </div>
                            <div class="collapse-body p-3 border border-t-0 rounded-b">

                                <p>Créée le : {{ item.campaign.created_at|date:"d/m/Y H:i" }} | Template : {{ item.campaign.template_file.name|default:"-" }}</p>

                                <!-- Plasmides de l'archive -->
                                <div class="collapse-container mb-2">
                                    <div class="collapse-header p-2 bg-gray-100 rounded cursor-pointer">
                                        <h4>Plasmides de l'archive</h4>
                                        <span class="collapse-toggle">▼</span>
                                    </div>
                                    <div class="collapse-body p-2 border border-t-0 rounded-b">
                                        {% if item.plasmids_archive %}
                                            <div class="templates-table overflow-x-auto">
                                                <table class="table-auto w-full border">
                                                    <thead>
                                                        <tr class="bg-gray-100">
                                                            <th class="border px-2 py-1">Nom</th>
                                                            <th class="border px-2 py-1">Organisme</th>
                                                            <th class="border px-2 py-1">Longueur (bp)</th>
                                                            <th class="border px-2 py-1">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for p in item.plasmids_archive %}
                                                        <tr>
                                                            <td class="border px-2 py-1">{{ p.name }}</td>
                                                            <td class="border px-2 py-1">{{ p.organism|default:"-" }}</td>
                                                            <td class="border px-2 py-1">{{ p.length|default:"-" }}</td>
                                                            <td class="border px-2 py-1 flex gap-1 flex-wrap">
                                                                <a href="{% url 'templates:user_view_plasmid_archive' item.campaign.id %}?plasmid={{ p.name|urlencode }}" class="btn btn-sm btn-secondary">Visualiser</a>
                                                                <a href="{% url 'templates:download_plasmid' %}?campaign_id={{ item.campaign.id }}&plasmid_name={{ p.name|urlencode }}" class="btn btn-sm btn-primary">Télécharger</a>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <p class="empty-row">Aucun plasmide dans l'archive.</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Plasmides du résultat -->
                                <div class="collapse-container mb-2">
                                    <div class="collapse-header p-2 bg-gray-100 rounded cursor-pointer">
                                        <h4>Plasmides du résultat</h4>
                                        <span class="collapse-toggle">▼</span>
                                    </div>
                                    <div class="collapse-body p-2 border border-t-0 rounded-b">
                                        {% if item.plasmids_results %}
                                            <div class="templates-table overflow-x-auto">
                                                <table class="table-auto w-full border">
                                                    <thead>
                                                        <tr class="bg-gray-100">
                                                            <th class="border px-2 py-1">Nom</th>
                                                            <th class="border px-2 py-1">Organisme</th>
                                                            <th class="border px-2 py-1">Longueur (bp)</th>
                                                            <th class="border px-2 py-1">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for p in item.plasmids_results %}
                                                        <tr>
                                                            <td class="border px-2 py-1">{{ p.name }}</td>
                                                            <td class="border px-2 py-1">{{ p.organism|default:"-" }}</td>
                                                            <td class="border px-2 py-1">{{ p.length|default:"-" }}</td>
                                                            <td class="border px-2 py-1 flex gap-1 flex-wrap">
                                                                <a href="{% url 'templates:user_view_plasmid' item.campaign.id %}?plasmid={{ p.name|urlencode }}" class="btn btn-sm btn-secondary">Visualiser</a>
                                                                <a href="{% url 'templates:download_plasmid' %}?campaign_id={{ item.campaign.id }}&plasmid_name={{ p.name|urlencode }}" class="btn btn-sm btn-primary">Télécharger</a>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <p class="empty-row">Aucun plasmide dans le résultat.</p>
                                        {% endif %}
                                    </div>
                                </div>

                            </div>
                        </div>
                        {% endfor %}

                {% else %}
                    <p>Aucune campagne trouvée.</p>
                {% endif %}
            {% endif %}

            <!-- Mes collections -->
            {% if filter_type == 'my_collections' %}
                {% if my_collections %}
                    {% for item in my_collections %}
                        <div class="collapse-container mb-4">
                            <div class="collapse-header p-2 bg-gray-200 rounded flex justify-between items-center">
                                <div>
                                    <h3>{{ item.collection.name }}</h3>
                                    <p class="text-sm text-gray-600">Créée le : {{ item.collection.created_at|date:"d/m/Y H:i" }}</p>
                                </div>
                                <span class="collapse-toggle">▼</span>
                            </div>
                            <div class="collapse-body p-3 border border-t-0 rounded-b">
                                {% if item.plasmids %}
                                    <div class="templates-table overflow-x-auto mt-2">
                                        <table class="table-auto w-full border">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="border px-2 py-1">Nom</th>
                                                    <th class="border px-2 py-1">Organisme</th>
                                                    <th class="border px-2 py-1">Longueur (bp)</th>
                                                    <th class="border px-2 py-1">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for p in item.plasmids %}
                                                    <tr>
                                                        <td class="border px-2 py-1">{{ p.name }}</td>
                                                        <td class="border px-2 py-1">{{ p.organism|default:"-" }}</td>
                                                        <td class="border px-2 py-1">{{ p.length|default:"-" }}</td>
                                                        <td class="border px-2 py-1 flex gap-1 flex-wrap">
                                                            <a href="{% url 'templates:download_single_plasmid' item.collection.id p.name %}" class="btn btn-sm btn-primary">
                                                                Télécharger
                                                            </a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="empty-row mt-2">Aucun plasmide trouvé dans cette collection.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="empty-row mt-4">Aucune collection trouvée.</p>
                {% endif %}
            {% endif %}
                                                            

            <!-- Collections de mes équipes -->
            {% if filter_type == 'team_collections' %}
                {% if team_collections %}
                    {% for item in team_collections %}
                        <div class="collapse-container mb-4">
                            <div class="collapse-header p-2 bg-gray-200 rounded flex justify-between items-center">
                                <div>
                                    <h4>Équipe : {{ item.collection.equipe.name }}</h4>
                                    <h3>{{ item.collection.name }}</h3>
                                    <p class="text-sm text-gray-600">Créée le : {{ item.collection.created_at|date:"d/m/Y H:i" }}</p>
                                </div>
                                <span class="collapse-toggle">▼</span>
                            </div>
                            <div class="collapse-body p-3 border border-t-0 rounded-b">
                                {% if item.plasmids %}
                                    <div class="templates-table overflow-x-auto mt-2">
                                        <table class="table-auto w-full border">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="border px-2 py-1">Nom</th>
                                                    <th class="border px-2 py-1">Organisme</th>
                                                    <th class="border px-2 py-1">Longueur (bp)</th>
                                                    <th class="border px-2 py-1">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for p in item.plasmids %}
                                                    <tr>
                                                        <td class="border px-2 py-1">{{ p.name }}</td>
                                                        <td class="border px-2 py-1">{{ p.organism|default:"-" }}</td>
                                                        <td class="border px-2 py-1">{{ p.length|default:"-" }}</td>
                                                        <td class="border px-2 py-1 flex gap-1 flex-wrap">
                                                            <a href="{% url 'templates:download_single_plasmid' item.collection.id p.name %}" class="btn btn-sm btn-primary">
                                                                Télécharger
                                                            </a>
                                                        </td>

                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="empty-row mt-2">Aucun plasmide trouvé dans cette collection.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="empty-row mt-4">Aucune collection trouvée.</p>
                {% endif %}
            {% endif %}

        {% else %}
            <p>Veuillez vous connecter pour voir vos plasmides privés.</p>
            <a href="{% url 'users:login' %}" class="btn btn-primary">Connexion</a>
        {% endif %}

    {% elif request.GET.privacy == "search_enter" %}
        <!-- Recherche NCBI reste inchangée -->
        <h3>Recherche avancée Entrez (NCBI)</h3>
        <form method="get" class="advanced-form">
            <input type="hidden" name="privacy" value="search_enter">
            <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="form-group">
                    <label>Nom du plasmide</label>
                    <input type="text" name="name" placeholder="ex: pUC19" value="{{ request.GET.name|default:'' }}">
                </div>
                <div class="form-group">
                    <label>Organisme</label>
                    <input type="text" name="organism" placeholder="ex: Escherichia coli" value="{{ request.GET.organism|default:'' }}">
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <input type="text" name="type" placeholder="ex: cloning vector" value="{{ request.GET.type|default:'' }}">
                </div>
                <div class="form-group">
                    <label>Site de fixation</label>
                    <input type="text" name="site" placeholder="ex: EcoRI" value="{{ request.GET.site|default:'' }}">
                </div>
                <div class="form-group">
                    <label>Bout de séquence</label>
                    <input type="text" name="sequence" placeholder="ex: ATGCGTAC" value="{{ request.GET.sequence|default:'' }}">
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Rechercher sur NCBI</button>
        </form>

        <p class="mt-4 text-gray-600 text-sm">
            Vous serez redirigé vers le site du NCBI (nuccore) avec les résultats correspondants.
        </p>
    {% endif %}

</main>

<script>
document.querySelectorAll(".collapse-header").forEach(header => {
    header.addEventListener("click", () => {
        const body = header.nextElementSibling;
        body.classList.toggle("collapsed");
        header.querySelector(".collapse-toggle").textContent = body.classList.contains("collapsed") ? "▼" : "▲";
    });
});
</script>
{% endblock %}
