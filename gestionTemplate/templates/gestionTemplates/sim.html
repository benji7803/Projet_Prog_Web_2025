{% extends "layout.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            {% if user.is_authenticated %}
                <h2 class="h4 mb-0">Simulation de Campagne (Utilisateur connect√©)</h2>
            {% else %}
                <h2 class="h4 mb-0">Simulation de Campagne (Utilisateur anonyme)</h2>
            {% endif %}
        </div>
        <div class="card-body">

            {% if error %}
                <div class="alert alert-danger" role="alert">
                    <strong>Erreur :</strong> {{ error }}
                </div>
            {% endif %}

            <!-- === Formulaire de simulation === -->
            <form id="simulation-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Champs cach√©s pour les s√©lections existantes -->
                <input type="hidden" id="template_existing" name="template_existing" value="">
                <input type="hidden" id="plasmid_collection_id" name="plasmid_collection_id" value="">
                <input type="hidden" id="mapping_template_id" name="mapping_template_id" value="">
                
                <!-- Fichiers requis -->
                <h4 class="text-secondary border-bottom pb-2 mb-3">1. Fichier Template Principal</h4>
                <div class="row mb-4">
                    <div class="col-md-6">
                        {{ form.template_file }}
                        <small class="text-danger d-block">{{ form.template_file.errors }}</small>
                    </div>
                    {% if user.is_authenticated and existing_templates %}
                    <div class="col-md-6">
                        <label class="form-label fw-bold">üìÅ Utiliser un fichier existant</label>
                        <select id="template_select" class="form-select" onchange="selectTemplate(this.value)">
                            <option value="">-- Aucun --</option>
                            {% for template in existing_templates %}
                                <option value="{{ template.id }}" data-name="{{ template.name }}" data-date="{{ template.created_at|date:'d/m/Y H:i' }}">
                                    {{ template.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>

                <h4 class="text-secondary border-bottom pb-2 mb-3 mt-4">2. Archive de Plasmides</h4>
                <div class="row mb-4">
                    <div class="col-md-6">
                        {{ form.plasmids_zip }}
                        <small class="text-muted d-block">{{ form.plasmids_zip.help_text }}</small>
                    </div>
                    {% if user.is_authenticated and plasmid_collections %}
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Utiliser une collection publi√©</label>
                        <select id="plasmids_select" class="form-select" onchange="selectCollection(this.value)">
                            <option value="">-- Aucune --</option>
                            {% for collection in plasmid_collections %}
                                <option value="{{ collection.id }}" data-name="{{ collection.name }}" data-count="{{ collection.plasmides.count }}">
                                    {{ collection.name }} ({{ collection.plasmides.count }} plasmide(s))
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>

                <h4 class="text-secondary border-bottom pb-2 mb-3 mt-4">3. Fichier de Correspondance</h4>
                <div class="row mb-4">
                    <div class="col-md-6">
                        {{ form.mapping_file }}
                        <small class="text-muted d-block">{{ form.mapping_file.help_text }}</small>
                    </div>
                    {% if user.is_authenticated and mapping_templates %}
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Utiliser un fichier publi√©</label>
                        <select id="mapping_select" class="form-select" onchange="selectMapping(this.value)">
                            <option value="">-- Aucun --</option>
                            {% for template in mapping_templates %}
                                <option value="{{ template.id }}" data-name="{{ template.name }}" data-date="{{ template.created_at|date:'d/m/Y H:i' }}">
                                    {{ template.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
                <div class="row">
                    <div class="col-md-5 mb-4">
                        <div class="card bg-light border-0 h-100 shadow-sm">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Enzyme</label>
                                    {{ form.enzyme }} 
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Concentration par d√©faut (ng/¬µL)</label>
                                    <input type="number" step="0.1" name="default_concentration" class="form-control" placeholder="Laisser vide = 200">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Paire d'amorces</label>
                                    <input type="text" name="primer_pairs" class="form-control" placeholder="Ex: P29,P30">
                                    <small class="text-muted">Laisser vide = None</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-7">
                        <div class="card border-0 h-100 shadow-sm">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">{{ form.primers_file.label }}</label>
                                    {{ form.primers_file }}
                                    <small class="text-muted d-block mt-1">{{ form.primers_file.help_text }}</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">{{ form.concentration_file.label }}</label>
                                    {{ form.concentration_file }}
                                    <small class="text-muted d-block mt-1">{{ form.concentration_file.help_text }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons -->
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-success fw-bold" id="simulate-btn">
                        Lancer la simulation et t√©l√©charger les r√©sultats
                    </button>
                    <a href="{% url 'templates:dashboard' %}" class="btn btn-outline-secondary">Annuler</a>
                </div>
            </form>

            <!-- Script de t√©l√©chargement et redirection -->
            <script>
            function selectTemplate(templateId) {
                if (templateId) {
                    document.getElementById('template_existing').value = templateId;
                    document.getElementById('template_file').value = '';
                } else {
                    document.getElementById('template_existing').value = '';
                }
            }

            function selectCollection(collectionId) {
                if (collectionId) {
                    document.getElementById('plasmid_collection_id').value = collectionId;
                    document.getElementById('plasmids_zip').value = '';
                } else {
                    document.getElementById('plasmid_collection_id').value = '';
                }
            }

            function selectMapping(mappingId) {
                if (mappingId) {
                    document.getElementById('mapping_template_id').value = mappingId;
                    document.getElementById('mapping_file').value = '';
                } else {
                    document.getElementById('mapping_template_id').value = '';
                }
            }

            // R√©initialiser les s√©lections quand on upload un fichier
            document.addEventListener('DOMContentLoaded', function() {
                const templateFile = document.getElementById('template_file');
                const plasmidsZip = document.getElementById('plasmids_zip');
                const mappingFile = document.getElementById('mapping_file');
                const templateSelect = document.getElementById('template_select');
                const plasmidsSelect = document.getElementById('plasmids_select');
                const mappingSelect = document.getElementById('mapping_select');

                if (templateFile) {
                    templateFile.addEventListener('change', function() {
                        if (this.files.length > 0) {
                            document.getElementById('template_existing').value = '';
                            if (templateSelect) templateSelect.value = '';
                        }
                    });
                }

                if (plasmidsZip) {
                    plasmidsZip.addEventListener('change', function() {
                        if (this.files.length > 0) {
                            document.getElementById('plasmid_collection_id').value = '';
                            if (plasmidsSelect) plasmidsSelect.value = '';
                        }
                    });
                }

                if (mappingFile) {
                    mappingFile.addEventListener('change', function() {
                        if (this.files.length > 0) {
                            document.getElementById('mapping_template_id').value = '';
                            if (mappingSelect) mappingSelect.value = '';
                        }
                    });
                }

                const form = document.getElementById('simulation-form');
                const simulateBtn = document.getElementById('simulate-btn');

                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const templateExisting = document.getElementById('template_existing').value;
                    const collectionId = document.getElementById('plasmid_collection_id').value;
                    const mappingId = document.getElementById('mapping_template_id').value;

                    // Validation de base
                    if (!templateExisting && !templateFile.value) {
                        alert('Veuillez s√©lectionner ou uploader un fichier de template');
                        return;
                    }
                    if (!collectionId && !plasmidsZip.value) {
                        alert('Veuillez s√©lectionner ou uploader une archive de plasmides');
                        return;
                    }
                    if (!mappingId && !mappingFile.value) {
                        alert('Veuillez s√©lectionner ou uploader un fichier de correspondance');
                        return;
                    }

                    const formData = new FormData(form);

                    simulateBtn.disabled = true;
                    simulateBtn.innerText = "Simulation en cours...";

                    fetch("", { method: "POST", body: formData })
                        .then(response => {
                            if (!response.ok) throw new Error("Erreur pendant la simulation (" + response.status + ")");
                            const contentDisposition = response.headers.get("Content-Disposition");
                            const headerName = response.headers.get("X-Suggested-Filename");
                            let filename = "resultats_simulation.zip";
                            if (headerName) filename = headerName;
                            else if (contentDisposition) {
                                const match = contentDisposition.match(/filename="?([^"]+)"?/);
                                if (match) filename = match[1];
                            }
                            return response.blob().then(blob => ({ blob, filename }));
                        })
                        .then(({ blob, filename }) => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            window.URL.revokeObjectURL(url);
                            window.location.href = "{% url 'templates:dashboard' %}";
                        })
                        .catch(error => {
                            alert("Erreur : " + error.message);
                            simulateBtn.disabled = false;
                            simulateBtn.innerText = "Lancer la simulation et t√©l√©charger les r√©sultats";
                        });
                });
            });
            </script>

        </div>
    </div>
</div>
{% endblock %}