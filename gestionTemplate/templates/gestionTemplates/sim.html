{% extends 'layout.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
        {% if user.is_authenticated %}
            <h2 class="h4 mb-0">Simulation de Campagne (Utilisateur connect√©)</h2>
        {% else %}
            <h2 class="h4 mb-0">Simulation de Campagne (Utilisateur anonyme)</h2>
        {% endif %}
        </div>
        <div class="card-body">

            {% if error %}
                <div class="alert alert-danger" role="alert">
                    <strong>Erreur :</strong> {{ error }}
                </div>
            {% endif %}

            <!-- === Formulaire de simulation === -->
            <form id="simulation-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <h4 class="text-secondary border-bottom pb-2 mb-3">1 Fichiers Requis</h4>
                <div class="row mb-3">
                    <div class="col-md-12 mb-3">
                        {{ form.template_file.label_tag }}
                        {{ form.template_file }}
                        <small class="text-danger">{{ form.template_file.errors }}</small>
                    </div>

                    <div class="col-md-6 mb-3">
                        {{ form.plasmids_zip.label_tag }}
                        {{ form.plasmids_zip }}
                        <small class="text-muted d-block">{{ form.plasmids_zip.help_text }}</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.mapping_file.label_tag }}
                        {{ form.mapping_file }}
                        <small class="text-muted d-block">{{ form.mapping_file.help_text }}</small>
                    </div>
                </div>

                <h4 class="text-secondary border-bottom pb-2 mb-3 mt-4">2 Param√®tres Optionnels</h4>
                <div class="row">
                    <div class="col-md-5 mb-4">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Enzyme</label>
                                    {{ form.enzyme }} 
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Concentration par d√©faut (ng/¬µL)</label>
                                    <input type="number" step="0.1" name="default_concentration" class="form-control" placeholder="Laisser vide = 200">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Paire d'amorces</label>
                                    <input type="text" name="primer_pairs" class="form-control" placeholder="Ex: P29,P30">
                                    <small class="text-muted">Laisser vide = None</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-7">
                        <div class="card border-0 h-100">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">{{ form.primers_file.label }}</label>
                                    {{ form.primers_file }}
                                    <small class="text-muted d-block mt-1">{{ form.primers_file.help_text }}</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">{{ form.concentration_file.label }}</label>
                                    {{ form.concentration_file }}
                                    <small class="text-muted d-block mt-1">{{ form.concentration_file.help_text }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success" id="simulate-btn">
                        Lancer la simulation et t√©l√©charger les r√©sultats
                    </button>
                    <a href="{% url 'templates:dashboard' %}" class="btn btn-outline-secondary">Annuler</a>
                </div>
            </form>

            <!-- === Script de gestion du t√©l√©chargement et redirection === -->
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('simulation-form');
                const simulateBtn = document.getElementById('simulate-btn');

                form.addEventListener('submit', function(event) {
                    event.preventDefault(); // emp√™che le rechargement
                    const formData = new FormData(form);

                    simulateBtn.disabled = true;
                    simulateBtn.innerText = "Simulation en cours...";

                    fetch("", {
                        method: "POST",
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Erreur pendant la simulation (" + response.status + ")");
                        }
                        // üßæ R√©cup√®re le nom du fichier depuis les headers HTTP
                        const contentDisposition = response.headers.get("Content-Disposition");
                        const headerName = response.headers.get("X-Suggested-Filename");
                        let filename = "resultats_simulation.zip";

                        if (headerName) {
                            filename = headerName;
                        } else if (contentDisposition) {
                            const match = contentDisposition.match(/filename="?([^"]+)"?/);
                            if (match) filename = match[1];
                        }

                        return response.blob().then(blob => ({ blob, filename }));
                    })
                    .then(({ blob, filename }) => {
                        // D√©clenche le t√©l√©chargement avec le bon nom
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);

                        // Redirection vers le dashboard
                        window.location.href = "{% url 'templates:dashboard' %}";
                    })
                    .catch(error => {
                        alert("Erreur : " + error.message);
                        simulateBtn.disabled = false;
                        simulateBtn.innerText = "Lancer la simulation et t√©l√©charger les r√©sultats";
                    });
                });
            });
            </script>

        </div>
    </div>
</div>
{% endblock %}
