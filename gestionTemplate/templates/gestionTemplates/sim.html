{% extends "layout.html" %}

{% block content %}
<main class="container">
    <h2 class="mb-4" style="color:#003b66;">Simulation de Campagne</h2>

    {% if user.is_authenticated %}
        <p class="text-muted">Bienvenue, <strong>{{ user.username }}</strong>. Vous pouvez utiliser vos fichiers sauvegardés ou en importer de nouveaux.</p>
    {% else %}
        <div class="alert alert-info">Vous n’êtes pas connecté. Vous pouvez tout de même lancer une simulation, mais les fichiers ne seront pas sauvegardés.</div>
    {% endif %}

    {% if error %}
        <div class="alert alert-danger" role="alert">
            <strong>Erreur :</strong> {{ error }}
        </div>
    {% endif %}

    <form id="simulation-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Champs cachés -->
        <input type="hidden" id="template_existing" name="template_existing" value="">
        <input type="hidden" id="plasmid_collection_id" name="plasmid_collection_id" value="">
        <input type="hidden" id="mapping_template_id" name="mapping_template_id" value="">

        <!-- === 1. TEMPLATE PRINCIPAL === -->
        <section class="collapse-container">
            <div class="collapse-header">
                <h3>1. Fichier Template Principal</h3>
                <span class="collapse-toggle">▼</span>
            </div>
            <div class="collapse-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Uploader un fichier Excel (.xlsx)</label>
                        {{ form.template_file }}
                    </div>
                    {% if user.is_authenticated and existing_templates %}
                    <div class="form-group">
                        <label>Ou utiliser un fichier existant</label>
                        <select id="template_select" class="form-select" onchange="selectTemplate(this.value)">
                            <option value="">-- Aucun --</option>
                            {% for template in existing_templates %}
                                <option value="{{ template.id }}">{{ template.name }} ({{ template.created_at|date:'d/m/Y H:i' }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- === 2. ARCHIVE DE PLASMIDES === -->
        <section class="collapse-container">
            <div class="collapse-header">
                <h3>2. Archive de Plasmides</h3>
                <span class="collapse-toggle">▼</span>
            </div>
            <div class="collapse-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Uploader une archive (.zip, .tar, .tar.gz)</label>
                        {{ form.plasmids_zip }}
                        <small class="text-muted">{{ form.plasmids_zip.help_text }}</small>
                    </div>
                    {% if user.is_authenticated and plasmid_collections %}
                    <div class="form-group">
                        <label>Ou utiliser une collection existante</label>
                        <select id="plasmids_select" class="form-select" onchange="selectCollection(this.value)">
                            <option value="">-- Aucune --</option>
                            {% for collection in plasmid_collections %}
                                <option value="{{ collection.id }}">{{ collection.name }} ({{ collection.plasmides.count }} plasmides)</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- === 3. FICHIER DE CORRESPONDANCE === -->
        <section class="collapse-container">
            <div class="collapse-header">
                <h3>3. Fichier de Correspondance</h3>
                <span class="collapse-toggle">▼</span>
            </div>
            <div class="collapse-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Uploader un fichier (.csv ou .xlsx)</label>
                        {{ form.mapping_file }}
                        <small class="text-muted">{{ form.mapping_file.help_text }}</small>
                    </div>
                    {% if user.is_authenticated and mapping_templates %}
                    <div class="form-group">
                        <label>Ou utiliser un fichier existant</label>
                        <select id="mapping_select" class="form-select" onchange="selectMapping(this.value)">
                            <option value="">-- Aucun --</option>
                            {% for template in mapping_templates %}
                                <option value="{{ template.id }}">{{ template.name }} ({{ template.created_at|date:'d/m/Y H:i' }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- === 4. PARAMÈTRES DE SIMULATION === -->
        <section class="collapse-container">
            <div class="collapse-header">
                <h3>4. Paramètres de Simulation</h3>
                <span class="collapse-toggle">▼</span>
            </div>
            <div class="collapse-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Enzyme</label>
                        {{ form.enzyme }}
                    </div>
                    <div class="form-group">
                        <label>Concentration par défaut (ng/µL)</label>
                        <input type="number" step="0.1" name="default_concentration" class="form-control" placeholder="Laisser vide = 200">
                    </div>
                    <div class="form-group">
                        <label>Paires d’amorces</label>
                        <input type="text" name="primer_pairs" class="form-control" placeholder="Ex: P29,P30">
                    </div>
                    <div class="form-group">
                        <label>{{ form.primers_file.label }}</label>
                        {{ form.primers_file }}
                        <small class="text-muted">{{ form.primers_file.help_text }}</small>
                    </div>
                    <div class="form-group">
                        <label>{{ form.concentration_file.label }}</label>
                        {{ form.concentration_file }}
                        <small class="text-muted">{{ form.concentration_file.help_text }}</small>
                    </div>
                </div>
            </div>
        </section>

        <!-- === Boutons === -->
        <div class="mt-4" style="text-align:right;">
            <button type="submit" class="btn btn-success" id="simulate-btn">Lancer la simulation</button>
            <a href="{% url 'templates:dashboard' %}" class="btn btn-outline-secondary">Annuler</a>
        </div>
    </form>
</main>

<script>
document.querySelectorAll(".collapse-header").forEach(header => {
    header.addEventListener("click", () => {
        const body = header.nextElementSibling;
        body.classList.toggle("collapsed");
    });
});

function selectTemplate(id) { document.getElementById('template_existing').value = id || ''; }
function selectCollection(id) { document.getElementById('plasmid_collection_id').value = id || ''; }
function selectMapping(id) { document.getElementById('mapping_template_id').value = id || ''; }

document.getElementById("simulation-form").addEventListener("submit", function(e) {
    const tFile = document.getElementById("id_template_file");
    const pFile = document.getElementById("id_plasmids_zip");
    const mFile = document.getElementById("id_mapping_file");
    const tId = document.getElementById("template_existing").value;
    const pId = document.getElementById("plasmid_collection_id").value;
    const mId = document.getElementById("mapping_template_id").value;
    if (!tFile.value && !tId) { alert("Veuillez sélectionner un fichier de template."); e.preventDefault(); }
    if (!pFile.value && !pId) { alert("Veuillez sélectionner une archive de plasmides."); e.preventDefault(); }
    if (!mFile.value && !mId) { alert("Veuillez sélectionner un fichier de correspondance."); e.preventDefault(); }
});
</script>
{% endblock %}
