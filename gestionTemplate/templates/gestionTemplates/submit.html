{% extends 'layout.html' %}

{% block title %}Soumettre un template{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <h1 class="mb-4 text-center">Soumettre un Template de Simulation</h1>

    {% if message %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    <!-- ===== PUBLICATION 1: FICHIER EXCEL PRINCIPAL ===== -->
    <div class="card mb-5 shadow-lg border-0">
        <div class="card-header bg-primary text-white py-3">
            <h3 class="mb-0"><span class="badge bg-white text-primary me-2">1: </span>Fichier Template Principal</h3>
        </div>
        <div class="card-body p-4">
            <p class="text-muted mb-4">Uploadez votre fichier de campagne (.xlsx) contenant la configuration de base pour la simulation</p>
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="file-upload" class="form-label fw-bold">Fichier Excel (.xlsx) *</label>
                    <input type="file" id="file-upload" name="uploaded_file" class="form-control form-control-lg" accept=".xlsx" required>
                    <small class="text-muted d-block mt-2">S√©lectionnez votre fichier de configuration</small>
                </div>

                {% if user.is_authenticated %}
                <div class="mb-3 form-check">
                    <input type="checkbox" id="publish-template" name="publish_template" class="form-check-input">
                    <label for="publish-template" class="form-check-label fw-bold">Rendre public</label>
                </div>
                <div class="mb-3">
                    <label for="publish-name" class="form-label small">Nom public (optionnel)</label>
                    <input type="text" id="publish-name" name="publish_name" class="form-control" placeholder="Nom du template public (optionnel)">
                </div>
                {% endif %}

                <button type="submit" class="btn btn-primary btn-lg">
                    Publier ce template
                </button>
            </form>
        </div>
    </div>

    <!-- ===== PUBLICATION 2: COLLECTION DE PLASMIDES ===== -->
    <div class="card mb-5 shadow-lg border-0">
        <div class="card-header bg-success text-white py-3">
            <h3 class="mb-0"><span class="badge bg-white text-success me-2">2: </span>Collection de Plasmides</h3>
        </div>
        <div class="card-body p-4">
            {% if user.is_authenticated %}
                <div class="row">
                    <!-- Colonne gauche: Cr√©er une nouvelle collection -->
                    <div class="col-lg-6 mb-4 mb-lg-0">
                        <div class="card h-100 bg-light">
                            <div class="card-body">
                                <p class="text-muted small mb-3">Sauvegardez une nouvelle collection pour la r√©utiliser dans d'autres simulations</p>
                                <form method="POST" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="collection-name" class="form-label fw-bold">Nom de la collection</label>
                                        <input type="text" id="collection-name" name="collection_name" class="form-control" placeholder="Collection Plasmides" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="collection-desc" class="form-label fw-bold">Description (optionnel)</label>
                                        <textarea id="collection-desc" name="collection_description" class="form-control" rows="2" placeholder="D√©crivez cette collection..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="collection-file" class="form-label fw-bold">Archive ZIP (.zip)</label>
                                        <input type="file" id="collection-file" name="collection_plasmid_archive" class="form-control" accept=".zip" required>
                                        <small class="text-muted d-block mt-2">Archive contenant vos fichiers GenBank (.gb)</small>
                                    </div>
                                    <button type="submit" name="save_collection" value="1" class="btn btn-success w-100">
                                        Publier cette collection
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne droite: Utiliser une collection existante -->
                    <div class="col-lg-6">
                        <div class="card h-100 bg-light">
                            <div class="card-header bg-white border-bottom">
                                <h5 class="mb-0">Mes collections sauvegard√©es</h5>
                            </div>
                            <div class="card-body d-flex flex-column">
                                {% if plasmid_collections %}
                                    <p class="text-muted small mb-3">{{ plasmid_collections|length }} collection(s) disponible(s)</p>
                                    <div class="alert alert-info small flex-grow-1 d-flex align-items-center" role="alert">
                                        Pour g√©rer, √©diter ou supprimer vos collections, consultez votre <a href="{% url 'users:profile' %}" class="alert-link">page profil</a>.
                                    </div>
                                    <a href="{% url 'users:profile' %}" class="btn btn-success w-100 mt-auto">
                                        Voir mes fichiers sauvegard√©s
                                    </a>
                                {% else %}
                                    <p class="text-muted small mb-3">Aucune collection sauvegard√©e pour le moment</p>
                                    <p class="text-muted text-center text-sm">Cr√©ez votre premi√®re collection avec le formulaire √† gauche</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Option upload direct pour workflow normal -->
                {% if data_html %}
                <hr class="my-4">
                <p class="text-muted mb-3"><strong>OU</strong> Uploader une archive directement (sans sauvegarder) :</p>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="plasmid-archive-direct" class="form-label fw-bold">Archive ZIP (.zip, .tar, .tar.gz)</label>
                        <input type="file" id="plasmid-archive-direct" name="plasmid_archive" class="form-control form-control-lg" accept=".zip,.tar,.tar.gz">
                        <small class="text-muted d-block mt-2">Archive contenant vos fichiers GenBank (.gb)</small>
                    </div>

                    {% if user.is_authenticated %}
                    <div class="mb-3">
                        <label for="collection-name-direct" class="form-label fw-bold">Nom de la collection (si vous souhaitez sauvegarder)</label>
                        <input type="text" id="collection-name-direct" name="collection_name" class="form-control" placeholder="Ex: Ma nouvelle collection">
                    </div>
                    <div class="mb-3">
                        <label for="collection-desc-direct" class="form-label">Description (optionnel)</label>
                        <textarea id="collection-desc-direct" name="collection_description" class="form-control" rows="2" placeholder="Description..."></textarea>
                    </div>
                    <button type="submit" name="save_collection" value="1" class="btn btn-outline-success me-2">üíæ Sauvegarder la collection</button>
                    {% endif %}

                    <button type="submit" class="btn btn-success btn-lg">
                        V√©rifier l'archive
                    </button>
                </form>
                {% endif %}
            {% else %}
                <div class="alert alert-info mb-4">
                    <strong>Conseil :</strong> <a href="{% url 'users:login' %}" class="alert-link">Connectez-vous</a> pour sauvegarder vos collections et les r√©utiliser dans d'autres simulations.
                </div>
                <p class="text-muted mb-4">Uploadez une archive directement :</p>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="plasmid-archive-anon" class="form-label fw-bold">Archive ZIP (.zip, .tar, .tar.gz) *</label>
                        <input type="file" id="plasmid-archive-anon" name="plasmid_archive" class="form-control form-control-lg" accept=".zip,.tar,.tar.gz" required>
                        <small class="text-muted d-block mt-2">Archive contenant vos fichiers GenBank (.gb)</small>
                    </div>
                    <button type="submit" class="btn btn-success btn-lg">
                        V√©rifier l'archive
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- ===== PUBLICATION 3: FICHIER DE CORRESPONDANCE ===== -->
    {% if user.is_authenticated %}
    <div class="card mb-5 shadow-lg border-0">
        <div class="card-header bg-info text-white py-3">
            <h3 class="mb-0"><span class="badge bg-white text-info me-2">3: </span>Fichier de Correspondance</h3>
        </div>
        <div class="card-body p-4">
            <div class="row">
                <!-- Colonne gauche: Cr√©er un nouveau fichier -->
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <div class="card h-100 bg-light">
                        <div class="card-body">
                            <p class="text-muted small mb-3">Sauvegardez un fichier de correspondance pour le r√©utiliser dans d'autres simulations</p>
                            <form method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="mapping-name" class="form-label fw-bold">Nom du fichier</label>
                                    <input type="text" id="mapping-name" name="mapping_name" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="mapping-desc" class="form-label fw-bold">Description (optionnel)</label>
                                    <textarea id="mapping-desc" name="mapping_description" class="form-control" rows="2" placeholder="D√©crivez ce fichier..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="mapping-file" class="form-label fw-bold">Fichier (.csv ou .xlsx) *</label>
                                    <input type="file" id="mapping-file" name="mapping_file_upload" class="form-control" accept=".csv,.xlsx" required>
                                    <small class="text-muted d-block mt-2">Fichier CSV ou Excel contenant les correspondances</small>
                                </div>
                                <button type="submit" name="save_mapping" value="1" class="btn btn-info text-white w-100">
                                    Publier ce fichier de correspondance
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Colonne droite: Utiliser un fichier existant -->
                <div class="col-lg-6">
                    <div class="card h-100 bg-light">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0">Mes fichiers sauvegard√©s</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            {% if mapping_templates %}
                                <p class="text-muted small mb-3">{{ mapping_templates|length }} fichier(s) disponible(s)</p>
                                <div class="alert alert-info small flex-grow-1 d-flex align-items-center" role="alert">
                                    Pour g√©rer, √©diter ou supprimer vos fichiers, consultez votre <a href="{% url 'users:profile' %}" class="alert-link">page profil</a>.
                                </div>
                                <a href="{% url 'users:profile' %}" class="btn btn-info text-white w-100 mt-auto">
                                    Voir mes fichiers sauvegard√©s
                                </a>
                            {% else %}
                                <p class="text-muted small mb-3">Aucun fichier sauvegard√© pour le moment</p>
                                <p class="text-muted text-center text-sm">Cr√©ez votre premier fichier avec le formulaire √† gauche</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ===== AFFICHAGE DES R√âSULTATS ===== -->
    {% if file_names %}
    <div class="card shadow-lg border-0">
        <div class="card-header bg-secondary text-white py-3">
            <h4 class="mb-0">‚úÖ Fichiers d√©tect√©s dans l'archive</h4>
        </div>
        <div class="card-body">
            <div class="list-group list-group-flush">
                {% for name in file_names %}
                    <div class="list-group-item">
                        <i class="bi bi-file-earmark"></i> {{ name }}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if nb_plasmid %}
    <div class="card mt-4 shadow-lg border-0">
        <div class="card-header bg-warning py-3">
            <h4 class="mb-0">‚öôÔ∏è S√©lection des fichiers</h4>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">Faites correspondre vos plasmides avec les fichiers de l'archive</p>
            {% for name in nb_plasmid %}
                <div class="mb-3">
                    <label for="file-select-{{ forloop.counter }}" class="form-label fw-bold">{{ name }} :</label>
                    <select name="selected_file_{{ forloop.counter }}" id="file-select-{{ forloop.counter }}" class="form-select">
                        <option value="">-- Choisir un fichier --</option>
                        {% for file in file_names %}
                            <option value="{{ file }}">{{ file }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}
    <h1 class="mb-4">Soumettre un template</h1>

    {% if message %}
        <div class="alert alert-info">{{ message }}</div>
    {% endif %}

    <!-- Formulaire pour le fichier principal -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">1. Upload du fichier principal</div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="file-upload" class="form-label">Fichier Excel (.xlsx)</label>
                    <input type="file" id="file-upload" name="uploaded_file" class="form-control" accept=".xlsx" required>
                </div>

                {% if user.is_authenticated %}
                <div class="mb-3 form-check">
                    <input type="checkbox" id="publish-template" name="publish_template" class="form-check-input">
                    <label for="publish-template" class="form-check-label">Rendre public</label>
                </div>
                <div class="mb-3">
                    <label for="publish-name" class="form-label small">Nom public (optionnel)</label>
                    <input type="text" id="publish-name" name="publish_name" class="form-control" placeholder="Nom du template public (optionnel)">
                </div>
                {% endif %}

                <button type="submit" class="btn btn-success">V√©rifier le fichier</button>
            </form>
        </div>
    </div>

    <!-- Section Collections et Correspondance pour utilisateurs authentifi√©s -->
    {% if user.is_authenticated %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark fw-bold">Mes Collections et Fichiers Sauvegard√©s</div>
        <div class="card-body">
            <!-- Tabs pour les collections et fichiers -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                {% if plasmid_collections %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="saved-collection-tab" data-bs-toggle="tab" data-bs-target="#saved-collection-pane" type="button" role="tab" aria-controls="saved-collection-pane" aria-selected="false">Mes Collections ({{ plasmid_collections|length }})</button>
                </li>
                {% endif %}
                {% if mapping_templates %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="saved-mapping-tab" data-bs-toggle="tab" data-bs-target="#saved-mapping-pane" type="button" role="tab" aria-controls="saved-mapping-pane" aria-selected="false">Mes Fichiers ({{ mapping_templates|length }})</button>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content">
                <!-- Tab Cr√©er une nouvelle collection -->
                <div class="tab-pane fade show active" id="new-collection-pane" role="tabpanel" aria-labelledby="new-collection-tab">
                    <p class="text-muted mb-3">Sauvegardez une nouvelle collection de plasmides pour la r√©utiliser ult√©rieurement</p>
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="collection-name" class="form-label">Nom de la collection *</label>
                            <input type="text" id="collection-name" name="collection_name" class="form-control" placeholder="Ex: Mes plasmides favoris" required>
                        </div>
                        <div class="mb-3">
                            <label for="collection-desc" class="form-label">Description (optionnel)</label>
                            <textarea id="collection-desc" name="collection_description" class="form-control" rows="2" placeholder="D√©crivez cette collection..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="collection-file" class="form-label">Archive ZIP de plasmides (.zip) *</label>
                            <input type="file" id="collection-file" name="collection_plasmid_archive" class="form-control" accept=".zip" required>
                            <small class="text-muted">S√©lectionnez une archive contenant vos fichiers .gb</small>
                        </div>
                        <button type="submit" name="save_collection" value="1" class="btn btn-success">üíæ Sauvegarder la collection</button>
                    </form>
                </div>

                <!-- Tab Collections sauvegard√©es -->
                {% if plasmid_collections %}
                <div class="tab-pane fade" id="saved-collection-pane" role="tabpanel" aria-labelledby="saved-collection-tab">
                    <p class="text-muted mb-3">S√©lectionnez une collection de plasmides d√©j√† sauvegard√©e</p>
                    <ul class="list-group">
                        {% for collection in plasmid_collections %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ collection.name }}</strong>
                                    {% if collection.description %}<br><small class="text-muted">{{ collection.description }}</small>{% endif %}
                                    <br><small class="text-muted">{{ collection.plasmides.count }} plasmides ‚Ä¢ Cr√©√© le {{ collection.created_at|date:"d/m/Y" }}</small>
                                </div>
                                <form method="POST" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="plasmid_collection_id" value="{{ collection.id }}">
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Tab Cr√©er un fichier de correspondance -->
                <div class="tab-pane fade" id="new-mapping-pane" role="tabpanel" aria-labelledby="new-mapping-tab">
                    <p class="text-muted mb-3">Sauvegardez un fichier de correspondance pour le r√©utiliser ult√©rieurement</p>
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="mapping-name" class="form-label">Nom du fichier *</label>
                            <input type="text" id="mapping-name" name="mapping_name" class="form-control" placeholder="Ex: Correspondance du projet X" required>
                        </div>
                        <div class="mb-3">
                            <label for="mapping-desc" class="form-label">Description (optionnel)</label>
                            <textarea id="mapping-desc" name="mapping_description" class="form-control" rows="2" placeholder="D√©crivez ce fichier de correspondance..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="mapping-file" class="form-label">Fichier de correspondance (.csv ou .xlsx) *</label>
                            <input type="file" id="mapping-file" name="mapping_file_upload" class="form-control" accept=".csv,.xlsx" required>
                            <small class="text-muted">S√©lectionnez votre fichier de correspondance</small>
                        </div>
                        <button type="submit" name="save_mapping" value="1" class="btn btn-success">üíæ Sauvegarder le fichier</button>
                    </form>
                </div>

                <!-- Tab Fichiers sauvegard√©s -->
                {% if mapping_templates %}
                <div class="tab-pane fade" id="saved-mapping-pane" role="tabpanel" aria-labelledby="saved-mapping-tab">
                    <p class="text-muted mb-3">S√©lectionnez un fichier de correspondance d√©j√† sauvegard√©</p>
                    <ul class="list-group">
                        {% for template in mapping_templates %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ template.name }}</strong>
                                    {% if template.description %}<br><small class="text-muted">{{ template.description }}</small>{% endif %}
                                    <br><small class="text-muted">Cr√©√© le {{ template.created_at|date:"d/m/Y H:i" }}</small>
                                </div>
                                <form method="POST" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="mapping_template_id" value="{{ template.id }}">
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if data_html %}
    <!-- Formulaire pour l‚Äôarchive de plasmides -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white fw-bold">2. Archive de plasmides</div>
        <div class="card-body">
            <!-- Tabs pour choisir entre Upload ou Collection existante -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button" role="tab" aria-controls="upload-pane" aria-selected="true">Uploader une nouvelle archive</button>
                </li>
                {% if plasmid_collections %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="collection-tab" data-bs-toggle="tab" data-bs-target="#collection-pane" type="button" role="tab" aria-controls="collection-pane" aria-selected="false">Utiliser une collection existante</button>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content">
                <!-- Tab Upload -->
                <div class="tab-pane fade show active" id="upload-pane" role="tabpanel" aria-labelledby="upload-tab">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="plasmid-archive" class="form-label">Uploader une archive (.zip, .tar, .tar.gz)</label>
                            <input type="file" id="plasmid-archive" name="plasmid_archive" class="form-control" accept=".zip,.tar,.tar.gz">
                            <small class="text-muted">Uploader tous vos plasmides au format GenBank (.gb)</small>
                        </div>

                        {% if user.is_authenticated %}
                        <div class="mb-3">
                            <label for="collection-name" class="form-label">Nom de la collection (si vous souhaitez sauvegarder)</label>
                            <input type="text" id="collection-name" name="collection_name" class="form-control" placeholder="Ex: Ma collection">
                        </div>
                        <div class="mb-3">
                            <label for="collection-desc" class="form-label">Description (optionnel)</label>
                            <textarea id="collection-desc" name="collection_description" class="form-control" rows="2" placeholder="Description..."></textarea>
                        </div>
                        <button type="submit" name="save_collection" value="1" class="btn btn-outline-success me-2">üíæ Sauvegarder la collection</button>
                        {% endif %}

                        <button type="submit" class="btn btn-success">V√©rifier l'archive</button>
                    </form>
                </div>

                <!-- Tab Collection existante -->
                {% if plasmid_collections %}
                <div class="tab-pane fade" id="collection-pane" role="tabpanel" aria-labelledby="collection-tab">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="plasmid-collection-select" class="form-label">S√©lectionnez une collection</label>
                            <select id="plasmid-collection-select" name="plasmid_collection_id" class="form-select">
                                <option value="">-- Choisir une collection --</option>
                                {% for collection in plasmid_collections %}
                                    <option value="{{ collection.id }}">
                                        {{ collection.name }} ({{ collection.plasmides.count }} plasmides)
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Les plasmides de cette collection seront utilis√©s</small>
                        </div>
                        <button type="submit" class="btn btn-success">Utiliser cette collection</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

        {% if nb_plasmid %}
            <div class="card shadow-sm mb-4">
                <div class="card-header fw-bold">3. S√©lection des fichiers</div>
                <div class="card-body">
                    {% for name in nb_plasmid %}
                        <div class="mb-3">
                            <label for="file-select-{{ forloop.counter }}" class="form-label">{{ name }} :</label>
                            <select name="selected_file_{{ forloop.counter }}" id="file-select-{{ forloop.counter }}" class="form-select">
                                <option value="">-- Choisir un fichier de l'archive --</option>
                                {% for file in file_names %}
                                    <option value="{{ file }}">{{ file }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
