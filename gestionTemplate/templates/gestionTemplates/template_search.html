{% extends "layout.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h1>Templates</h1>

    <!-- Onglets principaux : publics / mes templates -->
    <div class="tabs flex w-full mb-6 bg-gray-100 rounded-lg overflow-hidden shadow-sm">
        <a href="?filter=public"
           class="tab flex-1 text-center py-3 font-semibold {% if filter_type == 'public' or not filter_type %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
           Templates publics
        </a>
        <a href="?filter=mine"
           class="tab flex-1 text-center py-3 font-semibold {% if filter_type == 'mine' %}bg-white border-b-4 border-blue-600 text-blue-600{% else %}text-gray-600{% endif %}">
           Mes templates
        </a>
    </div>

    <!-- ====================== -->
    <!-- Templates publics -->
    <!-- ====================== -->
    {% if filter_type == 'public' or not filter_type %}
        {% if public_templates %}
            {% for template in public_templates %}
                <div class="collapse-container mb-6 border rounded">
                    <div class="collapse-header p-3 bg-gray-200 rounded-t flex justify-between items-center cursor-pointer">
                        <h3 class="font-semibold">{{ template.name }}</h3>
                        <div class="flex items-center gap-2">
                            <span class="collapse-toggle">▲</span>
                            <a href="{% url 'templates:download_template' template.id %}" class="btn btn-sm btn-primary">Télécharger</a>
                        </div>
                    </div>
                    <div class="collapse-body p-3 border-t">
                        <p>{{ template.description|default:"Aucune description." }}</p>
                        <p class="text-sm text-gray-500">Par : {{ template.user.username }}</p>
                        {% if template.content %}
                            <table class="display table-auto w-full mt-2">
                                <thead>
                                    <tr>
                                        {% for col in template.columns %}
                                            <th class="border px-2 py-1">{{ col }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in template.content %}
                                        <tr>
                                            {% for cell in row %}
                                                <td class="border px-2 py-1">{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>Aucun contenu disponible pour ce template.</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="empty-row mt-2">Aucun template public disponible.</p>
        {% endif %}
    {% endif %}

    <!-- ====================== -->
    <!-- Mes templates -->
    <!-- ====================== -->
    {% if filter_type == 'mine' %}
        {% if my_templates %}
            {% for template in my_templates %}
                <div class="collapse-container mb-6 border rounded">
                    <div class="collapse-header p-3 bg-gray-200 rounded-t flex justify-between items-center cursor-pointer">
                        <h3 class="font-semibold">{{ template.name }}</h3>
                        <div class="flex items-center gap-2">
                            <span class="collapse-toggle">▲</span>
                            <a href="{% url 'templates:download_template' template.id %}" class="btn btn-sm btn-primary">Télécharger</a>
                            {% if not template.isPublic %}
                                <form action="{% url 'templates:request_table_public' %}" method="post" class="inline-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="table_id" value="{{ template.id }}">
                                    <button type="submit" class="btn btn-sm btn-success">Demander la mise publique</button>
                                </form>
                            {% else %}
                                <span class="status-badge done">Publique</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="collapse-body p-3 border-t">
                        <p>{{ template.description|default:"Aucune description." }}</p>
                        <p class="text-sm text-gray-500">Créé le : {{ template.created_at|date:"d/m/Y H:i" }}</p>
                        {% if template.content %}
                            <table class="display table-auto w-full mt-2">
                                <thead>
                                    <tr>
                                        {% for col in template.columns %}
                                            <th class="border px-2 py-1">{{ col }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in template.content %}
                                        <tr>
                                            {% for cell in row %}
                                                <td class="border px-2 py-1">{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>Aucun contenu disponible pour ce template.</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="empty-row mt-2">Vous n'avez aucun template personnel.</p>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

<script>
$(document).ready(function() {
    const langFR = {
        url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json',
        paginate: { first: "«", last: "»", next: "›", previous: "‹" }
    };

    // Initialiser DataTable pour tous les tableaux
    $('table.display').each(function(){
        $(this).DataTable({
            language: langFR,
            pageLength: 10,
            lengthChange: false,
            pagingType: "simple_numbers",
            dom: 'frtip'
        });
    });

    // Collapse simple avec flèche
    $('.collapse-header').each(function(){
        const toggle = $(this).find('.collapse-toggle');
        const body = $(this).next('.collapse-body');

        // tableau ouvert par défaut
        body.show();
        toggle.text('▲');

        // clic pour replier / déplier
        $(this).click(function(){
            body.slideToggle(200);
            toggle.text(body.is(':visible') ? '▲' : '▼');
        });
    });
});
</script>
{% endblock %}
